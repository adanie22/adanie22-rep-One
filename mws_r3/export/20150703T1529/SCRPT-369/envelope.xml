<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ns1:Envelope xmlns:ns1="http://servicemesh.com/agility/api" xmlns:ns2="http://servicemesh.com/core/messaging" ns1:version="3.0" ns1:productVersion="9.2.4">
    <ns1:Asset xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ns1:Script">
        <ns1:name>MWS2R3 - Avecto - Defendpoint Install</ns1:name>
        <ns1:id>389</ns1:id>
        <ns1:description></ns1:description>
        <ns1:uuid>7e01f041-8ffb-43e2-b215-b2840b1ea451</ns1:uuid>
        <ns1:assetType>
            <ns1:name>script</ns1:name>
            <ns1:href>assettype/2</ns1:href>
            <ns1:id>2</ns1:id>
            <ns1:rel>up</ns1:rel>
            <ns1:type>application/com.servicemesh.agility.api.AssetType+xml</ns1:type>
            <ns1:position>0</ns1:position>
        </ns1:assetType>
        <ns1:top>true</ns1:top>
        <ns1:assetPath>/Root/MWS2R3_SYD</ns1:assetPath>
        <ns1:detailedAssetPath>/Root:#ID#1:#TYPE#VMContainer/MWS2R3_SYD:#ID#8:#TYPE#VMProject</ns1:detailedAssetPath>
        <ns1:lifecycleVersion>-1</ns1:lifecycleVersion>
        <ns1:removable>true</ns1:removable>
        <ns1:domain>
            <ns1:name>domain1</ns1:name>
            <ns1:href>domain/1</ns1:href>
            <ns1:id>1</ns1:id>
            <ns1:rel>up</ns1:rel>
            <ns1:type>application/com.servicemesh.agility.api.Domain+xml</ns1:type>
            <ns1:position>0</ns1:position>
        </ns1:domain>
        <ns1:creator>
            <ns1:name>dridley</ns1:name>
            <ns1:href>user/12</ns1:href>
            <ns1:id>12</ns1:id>
            <ns1:rel>up</ns1:rel>
            <ns1:type>application/com.servicemesh.agility.api.User+xml</ns1:type>
            <ns1:position>0</ns1:position>
        </ns1:creator>
        <ns1:created>2015-07-02T15:23:29+10:00</ns1:created>
        <ns1:lockType>0</ns1:lockType>
        <ns1:lastModified>2015-07-02T15:28:46+10:00</ns1:lastModified>
        <ns1:parent>
            <ns1:name>MWS2R3_SYD</ns1:name>
            <ns1:href>project/8</ns1:href>
            <ns1:id>8</ns1:id>
            <ns1:rel>up</ns1:rel>
            <ns1:type>application/com.servicemesh.agility.api.Project+xml</ns1:type>
            <ns1:position>0</ns1:position>
        </ns1:parent>
        <ns1:slot>7942968e-09bd-4542-8c4f-8908e8b2d36f</ns1:slot>
        <ns1:version>4</ns1:version>
        <ns1:latest>false</ns1:latest>
        <ns1:publishComment></ns1:publishComment>
        <ns1:slotId>193</ns1:slotId>
        <ns1:publisher>
            <ns1:name>dridley</ns1:name>
            <ns1:href>user/12</ns1:href>
            <ns1:id>12</ns1:id>
            <ns1:rel>up</ns1:rel>
            <ns1:type>application/com.servicemesh.agility.api.User+xml</ns1:type>
            <ns1:position>0</ns1:position>
        </ns1:publisher>
        <ns1:versionStatus>active</ns1:versionStatus>
        <ns1:checkoutAllowed>false</ns1:checkoutAllowed>
        <ns1:headAllowed>false</ns1:headAllowed>
        <ns1:operatingSystem>Windows</ns1:operatingSystem>
        <ns1:enableExtensions>false</ns1:enableExtensions>
        <ns1:body># Load Common functions
. .\Logging.ps1
. .\GlobalRepository.ps1
. .\LaunchProcess.ps1
. .\FilesUtility.ps1
. .\PlatformUtils.ps1


# get current script location
$scriptPath = split-path -parent $MyInvocation.MyCommand.Definition
$scriptName = $MyInvocation.MyCommand.Name
 
ConfigureLogging $scriptPath $scriptName


#########################################################################
# Main
#########################################################################

#Use ArgList variable in Start-Process commands so embedded variables and env variables resolve

$DomainNetBIOS = 			(get-globalvariable(&quot;Global\DomainNetBIOS&quot;)).value
$EventSubscriptionGroup =	&quot;Avecto-GPO-Event Subscription Computers&quot;		# Security Group for Computer Accounts for the evevnt collector subscription
$SubscriptionXML =			&quot;$env:windir\Debug\Avecto\$env:computername-Avecto-EventCentralisationSubscription.xml&quot;


Log &quot;**** Starting: Avecto Defendpoint Install ****&quot;
Log &quot;`n&quot;


Log &quot;Install Avecto Defendpoint GPMC Snapin...&quot;
If ( Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object 'DisplayName' | Where-object {$_.DisplayName -Match 'Avecto Defendpoint Consoles'} )
{
	Log &quot;GPMC Snapin already installed&quot;
}
Else
{
	$arglist = &quot;/S /v/qn&quot;
	Start-Process -NoNewWindow -Wait -PassThru -FilePath &quot;$ScriptPath\Defendpoint\Binaries\DefendpointManagementConsoles_x64.exe&quot; -ArgumentList $arglist
	Log &quot;`n&quot;
}


Log &quot;Configuring Event Forwarding pre-requisites WinRM...&quot;
winrm quickconfig /q:true
wecutil qc /q:true
Log &quot;`n&quot;

Function StartSvc ($ServiceName)
{
	$svc = Get-Service | Where-Object {$_.name -eq &quot;$ServiceName&quot;}
    If ($svc.Status -ne &quot;Running&quot;)
	{
		Log &quot; - Staring the $ServiceName service&quot;
		Start-Service $ServiceName
		$svc = Get-Service | Where-Object {$_.name -eq &quot;$ServiceName&quot;}
	}
	Else
	{
		Log &quot; - The $ServiceName service is running&quot;
	}
	Log &quot;`n&quot;
}


Log &quot;Ensure WinRM is running...&quot;
StartSvc -ServiceName &quot;WinRM&quot;
Log &quot;Ensure Event Forwarding is running...&quot;
StartSvc -ServiceName &quot;Wecsvc&quot;
Log &quot;`n&quot;


# Installing Defendpoint Agent...&quot;
$DefendpointService = Get-Service | Where-Object {$_.name -eq &quot;Avecto Defendpoint Service&quot;}
If ($DefendpointService -ne $null)
{
	Log &quot; - The Defendpoint Client is already installed&quot;
    Log &quot;`n&quot;
}
Else
{
	Log &quot; - Defendpoint Client is not installed. Installing...&quot;
	# Deteremine which version of the client to install
	$OSArchitecture = Get-WmiObject Win32_OperatingSystem | Select-Object OSArchitecture
	If ($OSArchitecture.OSArchitecture -eq &quot;64-bit&quot;)
	{
		CMD /c Start /WAIT MSIEXEC.exe /i &quot;$ScriptPath\Defendpoint\Binaries\DefendpointClient_x64.msi&quot; /qn /norestart /log $env:windir\Debug\Avecto\$env:computername-DefendpointClient_x64.msi.log
		If ($LastExitCode -ne 0 -And $LastExitCode -ne 3010) {Log &quot;ERROR: $LastExitCode Failed to install Defendpoint Client. Exiting...&quot;; EXIT 1}
	}
	Else
	{
		CMD /c Start /WAIT MSIEXEC.exe /i &quot;$ScriptPath\Defendpoint\Binaries\DefendpointClient_x86.msi&quot; /qn /norestart /log $env:windir\Debug\Avecto\$env:computername-DefendpointClient_x86.msi.log
		If ($LastExitCode -ne 0 -And $LastExitCode -ne 3010) {Log &quot;ERROR: $LastExitCode Failed to install Defendpoint Client. Exiting...&quot;; EXIT 1}
	}
    Start-Sleep -Seconds 60
}

Log &quot;Stopping and disabling the Avecto Defendpoint Client service&quot;
If ($DefendpointService.Status -ne &quot;Stopped&quot;) {Stop-Service &quot;Avecto Defendpoint Service&quot;}
Set-Service &quot;Avecto Defendpoint Service&quot; -StartupType Disabled
Log &quot;`n&quot;


Log &quot;Auto configure the Event Viewer Subscription...&quot;						# Prereq is Defendpoing Client install and then a reboot
&amp; &quot;$ScriptPath\Defendpoint\Scripts\Avecto-EventFwd_Subscription.ps1&quot; -DomainName $DomainNetBIOS -EventForwardingComputerGroupName &quot;$EventSubscriptionGroup&quot; -XMLfile &quot;$SubscriptionXML&quot;
If (!(Test-Path -Path &quot;$SubscriptionXML&quot;)) {Log &quot;ERROR: Failed to create XML file. Exiting...&quot;; EXIT 1}
Log &quot;`n&quot;

Log &quot;Creating the Subscription...&quot;
wecutil cs &quot;$SubscriptionXML&quot;
If ($LastExitCode -eq 80)
{
	Log &quot;Subscription already exists&quot;
    Log &quot;`n&quot;
}
Else
{
	If ($LastExitCode -ne 0) {Log &quot;ERROR: $LastExitCode. Failed to create Subscription. Exiting...&quot;; EXIT 1}
}

Log &quot;Setting the subscription latency&quot;
wecutil ss &quot;Avecto Defendpoint Events&quot; /cm:MinLatency
If ($LastExitCode -ne 0) {Log &quot;ERROR: $LastExitCode. Failed to set subscription latency. Exiting...&quot;; EXIT 1}
Log &quot;`n&quot;


Log &quot;**** Finished: Avecto Defendpoint Install ****&quot;</ns1:body>
        <ns1:type>Guest</ns1:type>
        <ns1:language>
            <ns1:name>powershell</ns1:name>
            <ns1:href>scriptlanguage/5</ns1:href>
            <ns1:id>5</ns1:id>
            <ns1:rel>down</ns1:rel>
            <ns1:type>application/com.servicemesh.agility.api.ScriptLanguage+xml</ns1:type>
            <ns1:position>0</ns1:position>
        </ns1:language>
        <ns1:runAsAdmin>false</ns1:runAsAdmin>
        <ns1:timeout>1800</ns1:timeout>
        <ns1:retries>0</ns1:retries>
        <ns1:delay>300</ns1:delay>
        <ns1:errorAction>Abort</ns1:errorAction>
        <ns1:rebootRequired>true</ns1:rebootRequired>
        <ns1:runOnProvisionOnly>false</ns1:runOnProvisionOnly>
    </ns1:Asset>
</ns1:Envelope>
